# SPECT PSF Model Comparison - Default Configuration

# Data paths
# Single path (for local runs or single-source cluster sweep):
#data_path: /home/storage/prepared_data/oxford_patient_data/sirt3/SPECT

# Multiple paths (for cluster sweep over multiple data sources):
# When data_paths is set, cluster mode will sweep over all sources.
# In local mode, only the first path is used (or data_path if set).
data_paths:
  - "/home/storage/prepared_data/phantom_data/manc_nema_phantom_data/SPECT"
  # - "/home/storage/prepared_data/oxford_patient_data/sirt3/SPECT"
  # - "/home/storage/prepared_data/anthropomorphic_phantom/SPECT"

# SIMIND configuration
simind:
  config: "/home/sam/working/sirf_simind_connection/sirf_simind_connection/configs/MLD001_SCAN0.yaml"
  photon_energy: 81.5  # keV (middle of energy window)
  energy_lower: 39.84  # keV
  energy_upper: 126.16  # keV
  collimator: "ge-megp"  # Collimator type (CC runtime switch)
  source_type: "y90_frey"  # Source type (FI runtime switch)
  photon_multiplier: 1.0
  use_mpi: true  # Use MPI parallel execution
  num_mpi_cores: 6  # Number of MPI cores

# Data fidelity
data_fidelity:
  eta_floor: 1.0e-5
  counts_floor: 1.0e-8
  image_smoothing_fwhm: null    # [fz, fy, fx] in mm; smooth image after residual update

# Resolution modeling
resolution:
  psf_fwhm: [6.91, 6.91, 6.91]  # mm (x, y, z)
  stir_psf_params: [1.22, 0.03]  # [intercept, slope]

# Stochastic reconstruction parameters
stochastic:
  algorithm: SVRG  # Options: SVRG, SAGA
  num_subsets: 18
  num_epochs: 10
  initial_step_size: 0.5 # will be updated by armijo
  relaxation_eta: 0.00
  snapshot_update_interval: 18
  # Armijo step-size search settings (used when coordinator is active)
  armijo_trigger_every_n_epochs: 5  # e.g., 5 to force Armijo every 5 epochs
  use_armijo_after_correction: true
  armijo_beta: 0.5      # Backtracking factor
  armijo_max_iter: 20   # Max backtracking iterations
  armijo_tol: 0.1    # Sufficient decrease tolerance


# RDP prior parameters
rdp:
  beta_values: [0, 0.001, 0.01, 0.1]
  gamma: 1.0
  epsilon: 0.01
  stencil: 26
  both_directions: true
  boundary_condition: "Periodic"

  # Spatially varying penalty strength
  # Based on: kappa(x) = sqrt(A^T D[1/A(x_init)] A 1)
  # where A is the accurate (PSF/SIMIND) projector from coordinator
  spatial_beta:
    enabled: false          # Enable beta(x) = kappa(x)^2 * beta_base
    floor: 1.0e-6          # Minimum value for 1/A(x_init) to avoid div-by-zero
    normalize: false       # Normalize kappa to mean=1 (preserves overall beta scale)

# Preconditioning options
preconditioner:
  update_interval: 1
  mask_with_body_mask: true
  bsrem:
    update_interval: 1
    epsilon: 1.0e-8
    smooth: true
    smoothing_fwhm: [1,1,1]  # in mm
  prior:
    epsilon: 1.0e-8
  lehmer:
    p: 0.1
    epsilon: 1.0e-8

# SimindProjector update control
projector:
  prefetch_initial_correction: false  # Run a correction before the first iteration
  restart_reconstruction_on_correction_reset: false  # Restart when resetting residual/additive corrections
  n_corrections: 5  # Number of reconstruction cycles (total iterations = num_epochs * n_corrections)

# Reconstruction selection
reconstruction:
  modes: [5,2]  # Which modes to run

# Output options
output:
  save_intermediate: false
  verbose: false
  save_preconditioner: true
  preconditioner_interval: 18
  track_effective_objective: false  # Track objective with accurate projector (memory intensive)

# Restart / resume options
restart:
  enabled: false  # Resume from latest checkpoint image_{iteration}.hv if available

# Cluster submission defaults (used when --execution cluster)
cluster:
  job_name: psf_mode_beta
  runtime: "48:00:00"
  memory: "60G"
  cores: 1
  queue: null
  gpu: false
  submit: false           # Set true to submit by default
  python_executable: python
  env_setup_script: null
  logs_subdir: logs
  job_script: project_psf/cluster/psf_sweep_job.sh
  qsub_extra_args: []
